#!/usr/bin/env bash

if [[ -f $BUILD_DIR/environment.yml ]]; then
    puts-step 'Using Conda...'

    if [[ ! -f /app/.heroku/python/bin/conda ]]; then
        # Grap Miniconda.
        curl -O https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh

        # Install Miniconda.
        bash Miniconda3-latest-Linux-x86_64.sh -b -f -p /app/.heroku/python 2>&1 /dev/null

        # Delete Miniconda installer.
        rm -fr Miniconda3-latest-Linux-x86_64.sh
    fi

    if [[ ! -f requirements.txt ]]; then
        SKIP_PIP_INSTALL=1
        export SKIP_PIP_INSTALL
        pip freeze > requirements.txt
    fi

    FEATURE_NOMKL=1 conda env update -f environment.yml -n default


fi